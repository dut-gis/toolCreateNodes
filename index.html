<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="p5.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Tool create nodes</title>
</head>
<body>
    <div style="padding: 8px 8px;">
        <b>Node size: </b>
        <input type="range" min="4" max="15" value="10" id="nodeSize">
        <b>Node color: </b>
        <input type="color" id="nodeColor" value="#241ae8">
        <b>Node click color: </b>
        <input type="color" id="nodeAddPathColor" value="#ff003c">
        <b>Line color: </b>
        <input type="color" id="lineColor" value="#bcc418">
    </div>
    <div style="padding: 8px 8px;">
        <button onclick=objToJson()>LOG JSON</button>
        <button onclick="download('map.json', 'text/plain')">CREATE FILE</button>
        <a href="" id="a"></a> 
    </div>
    <script>
        var a = document.getElementById("a");
        var rangeNodeSize = document.getElementById("nodeSize");
        var nodeColor = document.getElementById("nodeColor");
        var nodeAddPathColor = document.getElementById("nodeAddPathColor");
        var lineColor = document.getElementById("lineColor");
        let img;
        nodes = [];
        nodeBegin = null;

        function objToJson(){
            console.log(JSON.stringify(nodes));
        }

        function download(name, type) {
            var file = new Blob([JSON.stringify(nodes)], {type: type});
            a.href = URL.createObjectURL(file);
            a.download = name;
            a.text = "DOWNLOAD";
        }

        function preload() {
            img = loadImage('map.jpg');
        }

        function setup() {
            createCanvas(1000.5, 1000.5);
        }

        function draw() {
            nodeSize = rangeNodeSize.value;
            image(img, 0,0,img.width/2, img.height/2);

            stroke(lineColor.value);
            fill(nodeColor.value);

            //draw paths
            nodes.forEach((e,index) => {
                e.paths.forEach(e2 => {
                    line(e.posX,e.posY,nodes[e2].posX,nodes[e2].posY);
                });
            });

            //draw line if function is add_path
            if(nodeBegin!=null){
                line(nodes[nodeBegin].posX,nodes[nodeBegin].posY,mouseX,mouseY);
            }

            //draw nodes
            stroke(color(0));
            nodes.forEach((e,index) => {
                if(nodeBegin!=null&&e.id==nodeBegin){
                    fill(nodeAddPathColor.value);
                    ellipse(e.posX,e.posY,nodeSize,nodeSize);
                    fill(nodeColor.value);
                }else{
                    ellipse(e.posX,e.posY,nodeSize,nodeSize);
                }
            });
        }

        function mousePressed() {
            nodeSize = rangeNodeSize.value;
            //Check node inside canvas
            if(mouseX<0||mouseY<0) return ;

            //Init node
            node = {
                id: nodes.length,
                posX: mouseX,
                posY: mouseY,
                paths: []      
            };
            a.text = "";

            //Check function is add path
            if(nodeBegin==null){
                for(let e of nodes){
                    if(getNodeDistance(e,node)<=nodeSize*2){
                        print("Switch to add path function");
                        nodeBegin = e.id;
                        return 1;
                    }
                }
            }else{
                for(let e of nodes){
                    if(getNodeDistance(e,node)<=nodeSize*2){
                        if(e.id==nodeBegin){
                            print("Switch to add node function");
                            nodeBegin = null;
                        }else{
                            e.paths.push(nodeBegin);
                            nodes[nodeBegin].paths.push(e.id);
                        }
                        return 1;
                    }
                }
            }
            console.log("Create node at: " + mouseX +", " +mouseY );
            nodes.push(node);
        }

       function getNodeDistance(a,b){
            distance = Math.sqrt(Math.abs(Math.pow(b.posX-a.posX,2)+Math.pow(b.posY-a.posY,2)));
            return distance;
       }

    </script>
</body>
</html>